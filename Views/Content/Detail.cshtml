@model cleanNETCoreMVC.Models.Content
@using cleanNETCoreMVC.Models;
@using Microsoft.EntityFrameworkCore;

@functions {
    public string ToHtmlNewLine(string? text) =>
        string.IsNullOrEmpty(text) ? "" : text.Replace("\r\n", "<br>").Replace("\n", "<br>");
}

@{
    ViewData["Title"] = Model.Title;
    var otherNews = ViewBag.OtherNews as List<Content> ?? new List<Content>();
    var isFavorite = ViewBag.IsFavorite as bool? ?? false;
}

@if (TempData["FavoriteSuccess"] != null)
{
    <div id="favorite-alert" class="fixed top-20 right-6 z-50 animate-fade-in">
        <div role="alert" class="alert alert-success shadow-lg flex items-center gap-4">
            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16" class="h-6 w-6 text-pink-500"><path d="M8 15s-1.314-1.053-3.053-2.684C2.07 10.07 0 8.21 0 5.905 0 3.905 1.686 2.5 4 2.5c1.104 0 2.09.555 2.645 1.357C7.91 3.055 8.896 2.5 10 2.5c2.314 0 4 1.405 4 3.405 0 2.305-2.07 4.165-4.947 6.411C9.314 13.947 8 15 8 15z"/></svg>
            <div>
                <h3 class="font-bold">Success!</h3>
                <div class="text-xs">@TempData["FavoriteSuccess"]</div>
            </div>
        </div>
    </div>
    <script>
        setTimeout(() => {
            const alert = document.getElementById('favorite-alert');
            if (alert) alert.remove();
        }, 2500);
    </script>
}

<div class="container mx-auto px-4 py-8 flex flex-col items-center">
    <div class="text-sm breadcrumbs mb-4 w-full max-w-3xl">
        <ul>
            <li><a href="/">หน้าหลัก</a></li>
            <li><a href="/@Model.Category.ToString().ToLower()">@Model.Category</a></li>
            <li class="font-bold">@Model.Title</li>
        </ul>
    </div>

    <article class="w-full max-w-3xl mx-auto">
        <h1 class="text-3xl md:text-4xl font-extrabold leading-tight mb-4">@Model.Title</h1>
        @if (User.Identity.IsAuthenticated)
        {
            <div class="mb-4">
                @if (!isFavorite)
                {
                    <form method="post" action="/favorites/add/@Model.Id" class="inline">
                        <button type="submit" class="btn btn-sm btn-outline btn-error"><i class="bi bi-heart"></i> เพิ่มในรายการโปรด</button>
                    </form>
                }
                else
                {
                    <form method="post" action="/favorites/remove/@Model.Id" class="inline">
                        <button type="submit" class="btn btn-sm btn-error"><i class="bi bi-heart-fill"></i> ลบออกจากรายการโปรด</button>
                    </form>
                }
            </div>
        }
        <div class="flex flex-wrap gap-4 items-center text-gray-500 text-sm mb-6">
            <span class="inline-flex items-center gap-1"><span class="badge badge-primary">@Model.Category</span></span>
            <span class="inline-flex items-center gap-1"><i class="bi bi-calendar"></i> @Model.CreatedAt.ToString("dd MMM yyyy")</span>
            <span class="inline-flex items-center gap-1"><i class="bi bi-person-circle"></i> @(Model.Author?.FirstName ?? "-") @(Model.Author?.LastName ?? "")</span>
        </div>
        @if (!string.IsNullOrEmpty(Model.ThumbnailUrl))
        {
            <div class="w-full mb-8 rounded-xl overflow-hidden bg-gray-100 flex justify-center">
                <img src="@Model.ThumbnailUrl" alt="@Model.Title" class="object-cover w-full max-h-[420px]" />
            </div>
        }
        <div class="prose max-w-none mb-8 text-lg leading-relaxed">
            @Html.Raw(ToHtmlNewLine(Model.Body ?? string.Empty))
        </div>
        <div class="mt-8 flex flex-wrap gap-2 items-center">
            <span class="text-gray-500 text-xs">แท็ก:</span>
            @if (Model.ContentTags != null)
            {
                foreach (var tag in Model.ContentTags.Select(ct => ct.Tag))
                {
                    <a href="/tag/@tag.Slug" class="badge badge-outline">@tag.Name</a>
                }
            }
        </div>
    </article>

    <div class="divider my-10 font-semibold text-lg">ข่าวอื่นๆ</div>

    <div class="w-full max-w-3xl grid grid-cols-1 md:grid-cols-3 gap-6">
        @if (otherNews.Any())
        {
            foreach (var news in otherNews.Take(3))
            {
                var url = $"/{news.Category.ToString().ToLower()}/{news.Slug}";
                <div class="card bg-base-100 shadow-sm hover:shadow-lg transition">
                    <figure class="h-32 overflow-hidden rounded-t-xl">
                        <img src="@(string.IsNullOrEmpty(news.ThumbnailUrl) ? "/img/no-image.png" : news.ThumbnailUrl)" alt="@news.Title" class="object-cover w-full h-full" />
                    </figure>
                    <div class="card-body p-4">
                        <span class="badge badge-primary mb-2">@news.Category</span>
                        <a href="@url" class="font-semibold text-base hover:underline line-clamp-2">@news.Title</a>
                        <p class="text-xs text-gray-500 mt-1">@news.CreatedAt.ToString("dd MMM yyyy")</p>
                        <div class="card-actions justify-end mt-2">
                            <a href="@url" class="btn btn-xs btn-outline btn-primary">อ่านต่อ</a>
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="col-span-3 text-center text-gray-400 py-8">ไม่มีข่าวอื่นๆ</div>
        }
    </div>
</div> 